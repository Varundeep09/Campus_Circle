{% extends 'base.html' %}
{% block title %}Social Feed{% endblock %}
{% block content %}
<div class="card" style="max-width: 800px; margin: 2rem auto;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
    <h1 style="color: #6366f1; font-size: 2rem; font-weight: bold;">Social Feed</h1>
    <a href="{% url 'social:create_post' %}" class="btn" style="font-size: 1rem; padding: 0.6rem 1.5rem;">+ New Post</a>
  </div>
  <form method="get" style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; align-items: center;">
    <input type="text" name="search" value="{{ request.GET.search|default:'' }}" placeholder="Search posts..." style="flex:1; min-width:180px; padding:0.6rem 1rem; border:1px solid #e0e7ef; border-radius:0.5rem; font-size:1rem;">
    <select name="author" style="padding:0.6rem 1rem; border:1px solid #e0e7ef; border-radius:0.5rem; font-size:1rem;">
      <option value="">All Authors</option>
      {% for author in authors %}
        <option value="{{ author.username }}" {% if request.GET.author == author.username %}selected{% endif %}>{{ author.username }}</option>
      {% endfor %}
    </select>
    <button type="submit" class="btn" style="padding:0.6rem 1.5rem; font-size:1rem;">Search</button>
  </form>
  <div style="display: flex; flex-direction: column; gap: 1.5rem;">
    {% for post in posts %}
      <div style="background: #f8fafc; border-radius: 1rem; box-shadow: 0 2px 8px rgba(99,102,241,0.07); padding: 1.5rem;">
        <div style="display: flex; align-items: center; margin-bottom: 0.5rem; gap: 0.7rem;">
          <a href="{% url 'users:profile' post.author.username %}" style="font-weight: 600; color: #06b6d4; margin-right: 0.2rem; text-decoration: underline;">{{ post.author.username }}</a>
          <span style="color: #64748b; font-size: 0.98rem;">({{ post.author.get_role_display }})</span>
          {% if post.author.is_alumni_verified or post.author.is_superuser %}
            <span title="Verified" style="color: #22c55e; font-size: 1.1rem; margin-left: 0.2rem;">&#10004;</span>
          {% endif %}
          <span style="color: #64748b; font-size: 0.98rem; margin-left: auto;">{{ post.created_at|date:"M d, Y H:i" }}</span>
        </div>
        <div style="margin-bottom: 0.7rem; color: #1e293b;">{{ post.content|linebreaks }}</div>
        {% if post.image %}
          <img src="{{ post.image.url }}" alt="Post image" style="max-width: 320px; border-radius: 0.5rem; margin-bottom: 0.7rem;">
        {% endif %}
        {% if post.pdf %}
          <p><a href="{{ post.pdf.url }}" style="color: #6366f1;">Download attached PDF</a></p>
        {% endif %}
        <div style="display: flex; align-items: center; gap: 1.2rem; margin-top: 0.7rem;">
          <span style="color: #6366f1; font-weight: 600;">&#x1F44D; {{ post.total_likes }}</span>
          <form action="{% url 'social:post_like_toggle' post.id %}" method="post" style="display:inline;">
            {% csrf_token %}
            {% if user in post.likes.all %}
              <button type="submit" class="btn" style="background: #e11d48; color: #fff; font-size: 0.95rem; padding: 0.4rem 1.1rem;">Unlike</button>
            {% else %}
              <button type="submit" class="btn" style="background: #06b6d4; color: #fff; font-size: 0.95rem; padding: 0.4rem 1.1rem;">Like</button>
            {% endif %}
          </form>
        </div>
        <!-- Comments section -->
        <div style="margin-top: 1.2rem;">
          <h4 style="color: #6366f1; font-size: 1.1rem; margin-bottom: 0.5rem;">Comments</h4>
          {% if post.comments.all %}
            <ul style="list-style:none; padding:0; margin:0;">
              {% for comment in post.comments.all %}
                <li style="margin-bottom:0.5rem;">
                  <a href="{% url 'users:profile' comment.author.username %}" style="font-weight: 600; color: #06b6d4; text-decoration: underline;">{{ comment.author.username }}</a>
                  <span style="color: #64748b; font-size: 0.95rem;">({{ comment.author.get_role_display }})</span>
                  {% if comment.author.is_alumni_verified or comment.author.is_superuser %}
                    <span title="Verified" style="color: #22c55e; font-size: 1rem;">&#10004;</span>
                  {% endif %}
                  <span style="color: #64748b; font-size: 0.92rem; margin-left:0.5rem;">{{ comment.created_at|date:"M d, Y H:i" }}</span>
                  <div style="margin-left:1.2rem; color:#1e293b;">{{ comment.content|linebreaks }}</div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div style="color: #888; font-size: 1rem;">No comments yet.</div>
          {% endif %}
          <form method="post" style="margin-top:0.7rem; display:flex; gap:0.7rem;">
            {% csrf_token %}
            <input type="hidden" name="comment_post_id" value="{{ post.id }}">
            {{ comment_form.content }}
            <button type="submit" class="btn" style="padding:0.5rem 1.2rem; font-size:1rem;">Comment</button>
          </form>
        </div>
      </div>
    {% empty %}
      <div style="color: #888; font-size: 1.1rem;">No posts found.</div>
    {% endfor %}
  </div>
</div>
{% endblock %}