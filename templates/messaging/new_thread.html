{% extends 'base.html' %}
{% load static %}
{% block title %}New Conversation{% endblock %}

{% block content %}
<div style="max-width: 600px; margin: 0 auto;">
  <div class="card" style="margin: 2rem auto;">
    <div style="text-align: center; margin-bottom: 2rem;">
      <div style="width: 80px; height: 80px; background: var(--gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
        <i class="fas fa-comments" style="color: white; font-size: 2rem;"></i>
      </div>
      <h1 style="color: var(--primary); font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem;">Start New Conversation</h1>
      <p style="color: var(--secondary); font-size: 1.1rem;">Connect with your classmates and colleagues</p>
    </div>
    
    <form method="post" style="display: flex; flex-direction: column; gap: 1.5rem;">
      {% csrf_token %}
      <div>
        <label style="display: block; color: var(--primary); font-weight: 600; margin-bottom: 0.5rem;">Search & Select Recipients</label>
        <div style="position: relative;">
          <input type="text" id="userSearch" placeholder="Type to search users..." style="width: 100%; padding: 1rem; border: 2px solid rgba(99, 102, 241, 0.1); border-radius: 1rem; font-size: 1rem; background: rgba(99, 102, 241, 0.05); outline: none; transition: all 0.3s;">
          <div id="searchResults" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 1rem; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); max-height: 200px; overflow-y: auto; z-index: 1000; display: none;"></div>
        </div>
        <div id="selectedUsers" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem;"></div>
        <input type="hidden" name="recipients" id="recipientsInput" required>
      </div>
      
      <div>
        <label style="display: block; color: var(--primary); font-weight: 600; margin-bottom: 0.5rem;">First Message</label>
        <textarea name="content" rows="4" placeholder="Type your message here..." required style="width: 100%; padding: 1rem; border: 2px solid rgba(99, 102, 241, 0.1); border-radius: 1rem; font-size: 1rem; background: rgba(99, 102, 241, 0.05); resize: vertical; outline: none; transition: all 0.3s; font-family: inherit;"></textarea>
      </div>
      
      <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem;">
        <button type="submit" class="btn" style="background: var(--success); padding: 1rem 2rem; font-size: 1.1rem;">
          <i class="fas fa-paper-plane"></i> Start Conversation
        </button>
        <a href="{% url 'messaging:inbox' %}" class="btn" style="background: transparent; color: var(--primary); border: 2px solid var(--primary); padding: 1rem 2rem;">
          <i class="fas fa-times"></i> Cancel
        </a>
      </div>
    </form>
  </div>
</div>

<script>
let selectedUsers = [];
let searchTimeout;

document.getElementById('userSearch').addEventListener('input', function() {
  const query = this.value.trim();
  clearTimeout(searchTimeout);
  
  if (query.length >= 2) {
    searchTimeout = setTimeout(() => {
      fetch(`/messaging/search-users/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          displaySearchResults(data.users);
        });
    }, 300);
  } else {
    document.getElementById('searchResults').style.display = 'none';
  }
});

function displaySearchResults(users) {
  const resultsDiv = document.getElementById('searchResults');
  
  if (users.length === 0) {
    resultsDiv.style.display = 'none';
    return;
  }
  
  resultsDiv.innerHTML = users.map(user => `
    <div onclick="selectUser(${user.id}, '${user.username}', '${user.full_name}', '${user.role}')" style="padding: 1rem; cursor: pointer; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 0.75rem; transition: all 0.3s;" onmouseover="this.style.background='rgba(99, 102, 241, 0.1)'" onmouseout="this.style.background='transparent'">
      <img src="${user.avatar}" alt="${user.username}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent);">
      <div>
        <div style="font-weight: 600; color: var(--primary);">${user.full_name}</div>
        <div style="font-size: 0.9rem; color: var(--secondary);">@${user.username} • ${user.role}</div>
      </div>
    </div>
  `).join('');
  
  resultsDiv.style.display = 'block';
}

function selectUser(id, username, fullName, role) {
  if (selectedUsers.find(u => u.id === id)) return;
  
  selectedUsers.push({id, username, fullName, role});
  updateSelectedUsers();
  document.getElementById('userSearch').value = '';
  document.getElementById('searchResults').style.display = 'none';
}

function removeUser(id) {
  selectedUsers = selectedUsers.filter(u => u.id !== id);
  updateSelectedUsers();
}

function updateSelectedUsers() {
  const container = document.getElementById('selectedUsers');
  const input = document.getElementById('recipientsInput');
  
  container.innerHTML = selectedUsers.map(user => `
    <div style="background: rgba(99, 102, 241, 0.1); color: var(--accent); padding: 0.5rem 1rem; border-radius: 2rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; font-weight: 600;">
      ${user.fullName} (${user.role})
      <button type="button" onclick="removeUser(${user.id})" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1rem; padding: 0; margin-left: 0.25rem;">×</button>
    </div>
  `).join('');
  
  input.value = selectedUsers.map(u => u.username).join(',');
}

document.addEventListener('click', function(e) {
  if (!e.target.closest('#userSearch') && !e.target.closest('#searchResults')) {
    document.getElementById('searchResults').style.display = 'none';
  }
});
</script>

<style>
input:focus, textarea:focus {
  border-color: var(--accent) !important;
  background: #fff !important;
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1) !important;
}
</style>
{% endblock %}